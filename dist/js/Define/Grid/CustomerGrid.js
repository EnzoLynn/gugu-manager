var CustomerGrid_RightMenu=Ext.create("Ext.menu.Menu",{items:[ActionBase.getAction("refreshCustomer"),"-",ActionBase.getAction("addCustomer"),ActionBase.getAction("editCustomer"),"-",ActionBase.getAction("editCustomer_number"),ActionBase.getAction("addCustomerRent"),ActionBase.getAction("editCustomerRule")]});Ext.define("chl.gird.CustomerGrid",{alternateClassName:["CustomerGrid"],alias:"widget.CustomerGrid",extend:"chl.grid.BaseGrid",store:"CustomerGridStoreId",stateful:!1,actionBaseName:"CustomerGridAction",listeners:{itemclick:function(grid,record,hitem,index,e,opts){},itemdblclick:function(grid,record,hitem,index,e,opts){ActionBase.getAction("editCustomer").execute()},itemcontextmenu:function(view,rec,item,index,e,opts){e.stopEvent(),CustomerGrid_RightMenu.showAt(e.getXY())},beforeitemmousedown:function(view,record,item,index,e,options){},selectionchange:function(view,seles,op){seles[0]&&ActionBase.updateActions("CustomerGridAction",seles)}},columns:[],dockedItems:[{xtype:"toolbar",itemId:"toolbarID",dock:"top",layout:{overflowHandler:"Menu"},items:[ActionBase.getAction("refreshCustomer"),"-",ActionBase.getAction("addCustomer"),ActionBase.getAction("editCustomer"),"-",ActionBase.getAction("editCustomer_number"),ActionBase.getAction("addCustomerRent"),ActionBase.getAction("editCustomerRule"),"->",{fieldLabel:"按客户名查找",text:"按客户名查找",width:300,labelAlign:"right",labelWidth:80,xtype:"searchfield",paramName:"customer_name",itemId:"CustomerGridSearchfieldId",listeners:{render:function(){var me=this;me.store=GridManager.CustomerGrid.getStore()}}}]},{xtype:"Pagingtoolbar",itemId:"pagingtoolbarID",store:"CustomerGridStoreId",dock:"bottom",items:[]}],initComponent:function(){var me=this;me.callParent(arguments),ActionBase.setTargetView(me.actionBaseName,me),ActionBase.updateActions(me.actionBaseName,me.getSelectionModel().getSelection())},loadGrid:function(isSearch){var me=this,store=me.getStore(),sessiontoken=store.getProxy().extraParams.sessiontoken;!sessiontoken||0==sessiontoken.length;var filter={};store.filterMap.each(function(key,value,length){filter[key]=value}),store.getProxy().extraParams.filter=Ext.JSON.encode(filter),store.getProxy().extraParams.refresh=1,store.loadPage(1),store.getProxy().extraParams.refresh=null,ActionBase.updateActions(me.actionBaseName,me.getSelectionModel().getSelection())}}),GridManager.CreateCustomerGrid=function(param){var tmpArr=[{text:"编号",dataIndex:"customer_id",renderer:GlobalFun.UpdateRecord,width:100},{text:"客户名",dataIndex:"customer_name",renderer:GlobalFun.UpdateRecord,width:100},{text:"手机号",dataIndex:"mobile",renderer:GlobalFun.UpdateRecord,width:100},{text:"房租单价",dataIndex:"rent_area",renderer:GlobalFun.UpdateRecord,width:100,sortable:!1},{text:"面积单量比",dataIndex:"area_to_order_number",renderer:GlobalFun.UpdateRecord,width:100,sortable:!1},{text:"房租单价",dataIndex:"rent_pre_price",renderer:GlobalFun.UpdateRecord,width:100,sortable:!1},{text:"开始日期",dataIndex:"date_start",renderer:GlobalFun.UpdateRecord,width:100,sortable:!1},{text:"结束日期",dataIndex:"date_end",renderer:GlobalFun.UpdateRecord,width:100,sortable:!1}];return GridManager.CustomerGrid=Ext.create("chl.gird.CustomerGrid",GridManager.BaseGridCfg("CustomerGrid","CustomerGridState",tmpArr)),param&&param.needLoad&&GridManager.CustomerGrid.loadGrid(),GridManager.CustomerGrid},GridManager.SetCustomerGridSelectionChangeEvent=function(param){GridManager.CustomerGrid.on("selectionchange",function(view,seles,op){!seles[0]})},Ext.define("chl.Grid.AddUpdateCustomerWin",{extend:"Ext.window.Window",title:"添加",defaultFocus:"customer_nameItemId",iconCls:"",record:!1,height:120,width:830,layout:"vbox",modal:!0,resizable:!1,items:[{xtype:"form",itemId:"formId",autoScroll:!0,height:450,width:810,border:!1,bodyPadding:15,defaultType:"textfield",layout:{type:"table",columns:2},defaults:{labelAlign:"right",labelPad:15,width:340,labelWidth:125,maxLength:100,maxLengthText:"最大长度为100"},items:[{name:"customer_name",fieldLabel:"客户名",itemId:"customer_nameItemId",validateOnBlur:!1,allowBlank:!1,blankText:"不能为空"},{name:"mobile",fieldLabel:"手机号",itemId:"mobileItemId",validateOnBlur:!1,allowBlank:!1,blankText:"不能为空"}]}],buttons:[{text:"重置",handler:function(){var me=this,w=me.up("window"),f=w.down("#formId");if(f.getForm().reset(),"update"==w.action){var sm=w.grid.getSelectionModel();sm.hasSelection()&&f.getForm().loadRecord(sm.getSelection()[0])}}},{text:"确定",itemId:"submit",handler:function(){var me=this,w=me.up("window"),form=w.down("#formId").getForm();if(form.isValid()){var url="create"==w.action?GlobalConfig.Controllers.CustomerGrid.addCustomer:GlobalConfig.Controllers.CustomerGrid.updateCustomer;form.submit({url:url,params:{req:"dataset",dataname:"AddUpdateCustomer",restype:"json",Id:w.record?w.record.data.ControllTid:0,logId:w.record?w.record.data.Id:0,action:w.action,sessiontoken:GlobalFun.getSeesionToken()},success:function(form,action){w.grid.loadGrid(),w.close()},failure:function(form,action){GlobalFun.errorProcess(action.result.code)||Ext.Msg.alert("失败",action.result.msg)}})}}},{text:"取消",handler:function(){var me=this;me.up("window").close()}}]}),Ext.define("chl.Grid.AddUpdateCustomerRentWin",{extend:"Ext.window.Window",title:"添加",defaultFocus:"customer_nameItemId",iconCls:"",record:!1,height:650,width:830,layout:"vbox",modal:!0,resizable:!1,bodyPadding:5,items:[{xtype:"form",itemId:"formId",autoScroll:!0,height:170,width:810,border:!1,bodyPadding:5,defaultType:"textfield",layout:{type:"table",columns:2},defaults:{labelAlign:"right",labelPad:15,width:340,labelWidth:125,maxLength:100},items:[{name:"customer_name",xtype:"displayfield",fieldLabel:"客户名",itemId:"customer_nameItemId",validateOnBlur:!1,allowBlank:!1,blankText:"不能为空"},{name:"mobile",fieldLabel:"手机号",xtype:"displayfield",itemId:"mobileItemId",validateOnBlur:!1,allowBlank:!1,blankText:"不能为空"},{name:"rent_area",fieldLabel:"租贷面积（平米）",itemId:"rent_areaItemId",validateOnBlur:!1,allowBlank:!1,blankText:"不能为空",regex:GlobalConfig.RegexController.regexNumber,regexText:"请输入数字",maxLength:6},{name:"area_to_order_number",fieldLabel:"面积单量比",itemId:"area_to_order_numberItemId",validateOnBlur:!1,allowBlank:!1,blankText:"不能为空",regex:GlobalConfig.RegexController.regexMoney2Fixed,regexText:"请输入数字"},{name:"rent_pre_price",fieldLabel:"房租单价",validateOnBlur:!1,colspan:2,allowBlank:!1,blankText:"不能为空",regex:GlobalConfig.RegexController.regexMoney2Fixed,regexText:"请输入数字"},{xtype:"datefield",name:"date_start",format:"Y-m-d",fieldLabel:"开始时间",allowBlank:!1,blankText:"不能为空",itemId:"date_start",vtype:"daterange",endDateField:"date_end"},{xtype:"datefield",name:"date_end",format:"Y-m-d",fieldLabel:"结束时间",allowBlank:!1,blankText:"不能为空",itemId:"date_end",vtype:"daterange",startDateField:"date_start"},{xtype:"button",colspan:2,width:100,margin:"0 0 0 600",text:"添加",handler:function(com){var me=this,w=me.up("window"),form=w.down("#formId").getForm();if(form.isValid()){var url=GlobalConfig.Controllers.CustomerGrid.addCustomerRent;form.submit({url:url,params:{req:"dataset",dataname:"addCustomerRent",restype:"json",customerId:w.cid,action:w.action,sessiontoken:GlobalFun.getSeesionToken()},success:function(form,action){w.down("CustomerRentGrid").loadGrid()},failure:function(form,action){GlobalFun.errorProcess(action.result.code)||Ext.Msg.alert("失败",action.result.msg)}})}}},{name:"customer_id",xtype:"hidden"}]},{xtype:"CustomerRentGrid",margin:"5 0 0 0",height:400}],buttons:[{text:"关闭",handler:function(){var me=this;me.up("window").close()}}],listeners:{beforehide:function(com){WindowManager.AddUpdateCustomerRentWin.grid.store.load({scope:this,callback:function(records,operation,success){var record=WindowManager.AddUpdateCustomerRentWin.record;Ext.Array.each(records,function(item,index){return record.data.customer_id==item.data.customer_id?(record=item,!1):void 0});var sm=WindowManager.AddUpdateCustomerRentWin.grid.getSelectionModel();sm.select(record)}})}}}),Ext.define("chl.Grid.AddUpdateCustomerRuleWin",{extend:"Ext.window.Window",title:"添加",defaultFocus:"CustomerItemId",iconCls:"",record:!1,height:500,width:830,layout:"vbox",modal:!0,resizable:!1,items:[{xtype:"form",itemId:"formId",autoScroll:!0,height:450,width:810,border:!1,bodyPadding:5,defaultType:"displayfield",layout:{type:"table",columns:2},defaults:{labelAlign:"right",labelPad:15,width:340,labelWidth:125,maxLength:100,maxLengthText:"最大长度为100"},items:[{name:"customer_name",fieldLabel:"客户名",itemId:"customer_nameItemId",validateOnBlur:!1,allowBlank:!1,blankText:"不能为空"},{name:"mobile",fieldLabel:"手机号",itemId:"mobileItemId",validateOnBlur:!1,allowBlank:!1,blankText:"不能为空"},{name:"customize_number_from",fieldLabel:"发放面单号开始",itemId:"customize_number_fromItemId",validateOnBlur:!1,allowBlank:!1,blankText:"不能为空",regex:GlobalConfig.RegexController.regexNumber,regexText:"请输入数字"},{name:"customize_number_to",fieldLabel:"发放面单号结束",itemId:"customize_number_toItemId",validateOnBlur:!1,allowBlank:!1,blankText:"不能为空",regex:GlobalConfig.RegexController.regexNumber,regexText:"请输入数字"},{name:"rent_area",fieldLabel:"租贷面积（平米）",itemId:"rent_areaItemId",validateOnBlur:!1,allowBlank:!1,blankText:"不能为空",regex:GlobalConfig.RegexController.regexNumber,regexText:"请输入数字"},{name:"area_to_order_number",fieldLabel:"面积单量比",itemId:"area_to_order_numberItemId",validateOnBlur:!1,allowBlank:!1,blankText:"不能为空",regex:GlobalConfig.RegexController.regexMoney2Fixed,regexText:"请输入数字"},{name:"rent_pre_price",fieldLabel:"房租单价",validateOnBlur:!1,colspan:2,allowBlank:!1,blankText:"不能为空",regex:GlobalConfig.RegexController.regexMoney2Fixed,regexText:"请输入数字"},{minValue:new Date,name:"date_start",format:"Y-m-d",fieldLabel:"开始时间",allowBlank:!1,blankText:"不能为空",itemId:"date_start",vtype:"daterange",endDateField:"date_end"},{minValue:new Date,name:"date_end",format:"Y-m-d",fieldLabel:"结束时间",allowBlank:!1,blankText:"不能为空",itemId:"date_end",vtype:"daterange",startDateField:"date_start"},{xtype:"fieldset",colspan:2,title:"规则",itemId:"fs_rule",collapsible:!0,padding:"2 2 2 5",width:780,defaults:{labelAlign:"right",labelPad:15,xtype:"fieldset",defaults:{labelAlign:"right",labelPad:15,width:340,labelWidth:125,maxLength:100,maxLengthText:"最大长度为100"}},items:[],listeners:{boxready:function(com){var itemsArr=(com.up("window"),[]);for(key in GlobalConfig.Province)itemsArr.push({title:GlobalConfig.Province[key],items:[{xtype:"label",text:"现有规则:0",itemId:"lbl"+key},{xtype:"button",width:100,text:"添加规则",myval:key,handler:function(com){var param={sessiontoken:GlobalFun.getSeesionToken()};WsCall.call(GlobalConfig.Controllers.CustomerGrid.getCustomerRule,"GetCustomerRule",param,function(response,opts){function createRuleRow(rowData){var tempRuleItems=[];return Ext.Array.each(rowData,function(item,index,alls){var obj={};obj="0"==item.price_type?{xtype:"fieldset",collapsible:!0,title:"固定价格",width:770,layout:{type:"table",columns:2},defaults:{xtype:"displayfield",labelAlign:"right",labelPad:15,width:340,labelWidth:125,maxLength:100,maxLengthText:"最大长度为100"},items:[{fieldLabel:"起价",value:item.price_start},{fieldLabel:"后续单价",value:item.price_pre},{xtype:"button",rule_id:item.rule_id,colspan:2,width:100,margin:"0 0 0 630",text:"删除",handler:function(com){var rule_id=com.rule_id,param={rule_id:rule_id,sessiontoken:GlobalFun.getSeesionToken()};WsCall.call(GlobalConfig.Controllers.CustomerGrid.delCustomerRule,"delCustomerRule",param,function(response,opts){com.up("fieldset").destroy()},function(response,opts){GlobalFun.errorProcess(response.code)||Ext.Msg.alert("失败",response.msg)},!0,!1,com.up("window").getEl())}}]}:{xtype:"fieldset",title:"步进价格",width:770,collapsible:!0,items:[{xtype:"fieldset",title:"首重",layout:{type:"table",columns:2},defaults:{xtype:"displayfield",labelAlign:"right",labelPad:15,width:340,labelWidth:125,maxLength:100,maxLengthText:"最大长度为100"},items:[{fieldLabel:"起始重量(kg)",value:item.weight_min},{fieldLabel:"结束重量(kg)",value:item.weight_max},{fieldLabel:"价格",value:item.weight_start_price,colspan:2}]},{xtype:"fieldset",title:"续重",layout:{type:"table",columns:2},defaults:{xtype:"displayfield",labelAlign:"right",labelPad:15,width:340,labelWidth:125,maxLength:100,maxLengthText:"最大长度为100"},items:[{fieldLabel:"重量(kg)",value:item.weight_pre},{fieldLabel:"价格",value:item.weight_pre_price},{fieldLabel:"记重方式",colspan:2,value:item.weight_price_type}]},{xtype:"button",colspan:2,rule_id:item.rule_id,width:100,margin:"0 0 0 630",text:"删除",handler:function(com){var rule_id=com.rule_id,param={rule_id:rule_id,sessiontoken:GlobalFun.getSeesionToken()};WsCall.call(GlobalConfig.Controllers.CustomerGrid.delCustomerRule,"delCustomerRule",param,function(response,opts){GlobalConfig.CurrUserInfo=response.data[0],callBack()},function(response,opts){GlobalFun.errorProcess(response.code)||Ext.Msg.alert("失败",response.msg)},!0,!1,com.up("window").getEl())}}]},tempRuleItems.push(obj)}),tempRuleItems}var data=response.data;Ext.create("Ext.window.Window",{title:"添加规则("+GlobalConfig.Province[com.myval]+")",pid:com.myval,width:820,height:700,resizable:!1,action:"create",modal:!0,autoScroll:!0,layout:"vbox",bodyPadding:10,dockedItems:[{xtype:"container",dock:"top",border:!1,bodyPadding:15,layout:{type:"table",columns:2},defaultType:"textfield",defaults:{labelAlign:"right",labelPad:15,width:340,labelWidth:125,maxLength:100,maxLengthText:"最大长度为100"},items:[{xtype:"fieldcontainer",colspan:2,fieldLabel:"计价方式",defaultType:"radiofield",layout:"hbox",defaults:{flex:1},items:[{boxLabel:"固定价格",checked:!0,itemId:"rd_price0",name:"price_type",inputValue:"0",listeners:{change:function(com,nval,oval,opts){var me=this,win=me.up("window");nval?(win.down("#price_type0").show(),win.down("#price_type1").hide()):(win.down("#price_type1").show(),win.down("#price_type0").hide())}}},{boxLabel:"步进价格",itemId:"rd_price1",name:"price_type",inputValue:"1"}]},{xtype:"form",itemId:"price_type0",height:100,width:810,bodyPadding:15,layout:{type:"table",columns:2},defaults:{labelAlign:"right",labelPad:15,width:340,labelWidth:125,maxLength:100,maxLengthText:"最大长度为100"},items:[{xtype:"numberfield",fieldLabel:"起价",name:"price_start",minValue:0,decimalPrecision:3,maxValue:GlobalConfig.MaxLimit,allowBlank:!1,blankText:"不能为空"},{xtype:"numberfield",fieldLabel:"后续单价",name:"price_pre",minValue:0,decimalPrecision:3,maxValue:GlobalConfig.MaxLimit,allowBlank:!1,blankText:"不能为空"},{xtype:"button",itemId:"btn_add",colspan:2,margin:"0 0 0 580",width:100,text:"添加",handler:function(com){var me=this,w=me.up("window"),form=w.down("#price_type0").getForm();if(form.isValid()){var url=GlobalConfig.Controllers.CustomerGrid.addCustomerRule;form.submit({url:url,params:{req:"dataset",dataname:"addCustomerRule",restype:"json",price_type:0,province:w.pid,action:w.action,customer_rent_id:WindowManager.AddUpdateCustomerRuleWin.record.data.customer_rent_id,sessiontoken:GlobalFun.getSeesionToken()},success:function(form,action){var data=action.result.data,arr=createRuleRow(data);w.removeAll(),w.add(arr)},failure:function(form,action){GlobalFun.errorProcess(action.result.code)||Ext.Msg.alert("失败",action.result.msg)}})}}}]},{xtype:"form",colspan:2,bodyPadding:15,itemId:"price_type1",height:280,width:810,layout:{type:"table",columns:2},hidden:!0,items:[{xtype:"fieldset",title:"首重",width:780,colspan:2,layout:{type:"table",columns:2},defaults:{labelAlign:"right",labelPad:15,width:340,labelWidth:125},items:[{xtype:"numberfield",name:"weight_min",fieldLabel:"起始重量(kg)",minValue:0,value:0,decimalPrecision:3,maxValue:GlobalConfig.MaxLimit,allowBlank:!1,blankText:"不能为空"},{xtype:"numberfield",name:"weight_min_price",fieldLabel:"结束重量(kg)",minValue:0,value:1,maxValue:GlobalConfig.MaxLimit,decimalPrecision:3,allowBlank:!1,blankText:"不能为空"},{xtype:"numberfield",span:2,name:"weight_min_price",fieldLabel:"价格",decimalPrecision:2,minValue:0,maxValue:GlobalConfig.MaxLimit,regex:GlobalConfig.RegexController.regexMoney2Fixed,regexText:"请填写两位小数的数字",allowBlank:!1,blankText:"不能为空"}]},{xtype:"fieldset",title:"续重",width:780,layout:{type:"table",columns:2},defaults:{labelAlign:"right",labelPad:15,width:340,labelWidth:125},colspan:2,items:[{xtype:"numberfield",name:"weight_pre",fieldLabel:"重量(kg)",minValue:0,maxValue:GlobalConfig.MaxLimit,decimalPrecision:3,allowBlank:!1,blankText:"不能为空"},{xtype:"numberfield",name:"weight_pre_price",fieldLabel:"价格",decimalPrecision:2,minValue:0,maxValue:GlobalConfig.MaxLimit,allowBlank:!1,blankText:"不能为空"},{xtype:"fieldcontainer",colspan:2,fieldLabel:"记重方式",defaultType:"radiofield",layout:"hbox",defaults:{flex:1},items:[{boxLabel:"进位",checked:!0,name:"weight_price_type",inputValue:"0"},{boxLabel:"实重",name:"weight_price_type",inputValue:"1"}]}]},{fieldLabel:"排序",xtype:"numberfield",name:"sort_order",decimalPrecision:0,minValue:1,value:1},{xtype:"button",width:100,text:"添加",handler:function(com){var me=this,w=me.up("window"),form=w.down("#price_type1").getForm();if(w.add({xtype:"fieldset",title:"步进价格",items:[]}),w.down("#rd_price0").setDisabled(!0),form.isValid()){var url=GlobalConfig.Controllers.CustomerGrid.addCustomerRule;form.submit({url:url,params:{req:"dataset",dataname:"addCustomerRule",restype:"json",price_type:1,province:w.pid,action:w.action,customer_rent_id:WindowManager.AddUpdateCustomerRuleWin.record.data.customer_rent_id,sessiontoken:GlobalFun.getSeesionToken()},success:function(form,action){action.result.data},failure:function(form,action){GlobalFun.errorProcess(action.result.code)||Ext.Msg.alert("失败",action.result.msg)}})}}}]}]}],items:[],listeners:{boxready:function(com){var tempRuleItems=createRuleRow(data);com.add(tempRuleItems)},beforehide:function(com){var param={customer_rent_id:WindowManager.AddUpdateCustomerRuleWin.record.data.customer_rent_id,sessiontoken:GlobalFun.getSeesionToken()};WsCall.call(GlobalConfig.Controllers.CustomerGrid.GetCustomerRuleByRentId,"GetCustomerRuleByRentId",param,function(response,opts){var data=response.data;Ext.Array.each(data,function(item,index,alls){var temp=WindowManager.AddUpdateCustomerRuleWin.down("#lbl"+item.key);temp.setText("现有规则:"+item.count)})},function(response,opts){GlobalFun.errorProcess(response.code)||Ext.Msg.alert("失败",response.msg)},!1)}},buttons:[{text:"退出",handler:function(){var me=this;me.up("window").close()}}]}).show()},function(response,opts){GlobalFun.errorProcess(response.code)||Ext.Msg.alert("失败",response.msg)},!0)}}]});com.add(itemsArr)}}}]}],buttons:[{text:"关闭",handler:function(){var me=this;me.up("window").close()}}]});
//# sourceMappingURL=CustomerGrid.js.map